CREATE DATABASE IF NOT EXISTS cinema_db;
USE cinema_db;

CREATE TABLE users (
  user_id INT AUTO_INCREMENT PRIMARY KEY,
  full_name VARCHAR(100),
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255),
  phone VARCHAR(20),

  role ENUM('GUEST','CUSTOMER','STAFF','MANAGER','ADMIN') NOT NULL,

  branch_id INT NULL, 
  -- chỉ dùng cho STAFF / MANAGER

  status ENUM('active','inactive') DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE cinema_branches (
  branch_id INT AUTO_INCREMENT PRIMARY KEY,
  branch_name VARCHAR(100),
  city VARCHAR(100),   -- vì cùng 1 thành phố, có thể cố định
  address VARCHAR(255),
  status ENUM('active','inactive') DEFAULT 'active'
);

CREATE TABLE rooms (
  room_id INT AUTO_INCREMENT PRIMARY KEY,
  branch_id INT NOT NULL,
  room_name VARCHAR(50),
  total_seats INT,

  status ENUM('active','inactive') DEFAULT 'active',

  FOREIGN KEY (branch_id) REFERENCES cinema_branches(branch_id)
);

CREATE TABLE seats (
  seat_id INT AUTO_INCREMENT PRIMARY KEY,
  room_id INT NOT NULL,
  seat_row CHAR(2),
  seat_number INT,
  seat_type ENUM('NORMAL','VIP','COUPLE') DEFAULT 'NORMAL',
  FOREIGN KEY (room_id) REFERENCES rooms(room_id)
);

CREATE TABLE movies (
  movie_id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(150) NOT NULL,
  duration INT, -- thời lượng (phút)
  age_rating VARCHAR(10),
  description TEXT,
  poster_url VARCHAR(255),
  trailer_url VARCHAR(255),

  status ENUM('upcoming','now_showing','stopped') DEFAULT 'upcoming',
  is_hidden BOOLEAN DEFAULT FALSE
);

CREATE TABLE branch_movies (
  id INT AUTO_INCREMENT PRIMARY KEY,
  branch_id INT NOT NULL,
  movie_id INT NOT NULL,
  UNIQUE (branch_id, movie_id),
  FOREIGN KEY (branch_id) REFERENCES cinema_branches(branch_id),
  FOREIGN KEY (movie_id) REFERENCES movies(movie_id)
);

CREATE TABLE showtimes (
  showtime_id INT AUTO_INCREMENT PRIMARY KEY,
  movie_id INT NOT NULL,
  room_id INT NOT NULL,
  start_time DATETIME,
  end_time DATETIME,
  status ENUM('open','closed','cancelled') DEFAULT 'open',
  FOREIGN KEY (movie_id) REFERENCES movies(movie_id),
  FOREIGN KEY (room_id) REFERENCES rooms(room_id)
);

CREATE TABLE pricing (
  price_id INT AUTO_INCREMENT PRIMARY KEY,
  branch_id INT NOT NULL,
  seat_type ENUM('NORMAL','VIP','COUPLE'),
  time_range VARCHAR(50),
  price DECIMAL(10,2),
  FOREIGN KEY (branch_id) REFERENCES cinema_branches(branch_id)
);

CREATE TABLE bookings (
  booking_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  showtime_id INT NOT NULL,
  booking_type ENUM('online','counter') DEFAULT 'online',
  booking_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  status ENUM('pending','paid','cancelled') DEFAULT 'pending',
  total_amount DECIMAL(10,2),
  FOREIGN KEY (user_id) REFERENCES users(user_id),
  FOREIGN KEY (showtime_id) REFERENCES showtimes(showtime_id)
);

CREATE TABLE booking_seats (
  id INT AUTO_INCREMENT PRIMARY KEY,
  booking_id INT NOT NULL,
  seat_id INT NOT NULL,
  UNIQUE (booking_id, seat_id),
  FOREIGN KEY (booking_id) REFERENCES bookings(booking_id),
  FOREIGN KEY (seat_id) REFERENCES seats(seat_id)
);

CREATE TABLE payments (
  payment_id INT AUTO_INCREMENT PRIMARY KEY,
  booking_id INT NOT NULL,
  method ENUM('cash','card','online'),
  amount DECIMAL(10,2),
  payment_status ENUM('success','failed'),
  payment_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (booking_id) REFERENCES bookings(booking_id)
);

CREATE TABLE reviews (
  review_id INT AUTO_INCREMENT PRIMARY KEY,
  movie_id INT NOT NULL,
  user_id INT NOT NULL,
  rating INT CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,
  status ENUM('pending','approved') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (movie_id) REFERENCES movies(movie_id),
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE notifications (
  notification_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  title VARCHAR(100),
  content TEXT,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);
CREATE TABLE genres (
  genre_id INT AUTO_INCREMENT PRIMARY KEY,
  genre_name VARCHAR(100) UNIQUE NOT NULL,
  description VARCHAR(255),
  status ENUM('active','inactive') DEFAULT 'active'
);
CREATE TABLE movie_genres (
  id INT AUTO_INCREMENT PRIMARY KEY,
  movie_id INT NOT NULL,
  genre_id INT NOT NULL,

  UNIQUE (movie_id, genre_id),

  FOREIGN KEY (movie_id) REFERENCES movies(movie_id),
  FOREIGN KEY (genre_id) REFERENCES genres(genre_id)
);

INSERT INTO cinema_branches (branch_name, city, address) VALUES
('FPT Cinema Quận 1', 'TP.HCM', 'Quận 1'),
('FPT Cinema Quận 3', 'TP.HCM', 'Quận 3'),
('FPT Cinema Quận 7', 'TP.HCM', 'Quận 7'),
('FPT Cinema Tân Bình', 'TP.HCM', 'Tân Bình'),
('FPT Cinema Gò Vấp', 'TP.HCM', 'Gò Vấp');

INSERT INTO users (full_name, email, password_hash, phone, role, branch_id) VALUES
('Admin System', 'admin@cinema.com', 'hash1', '090000001', 'ADMIN', NULL),

('Manager Q1', 'manager.q1@cinema.com', 'hash2', '090000002', 'MANAGER', 1),
('Staff Q1', 'staff1.q1@cinema.com', 'hash3', '090000003', 'STAFF', 1),

('Manager Q3', 'manager.q3@cinema.com', 'hash4', '090000004', 'MANAGER', 2),
('Staff Q3', 'staff1.q3@cinema.com', 'hash5', '090000005', 'STAFF', 2),

('Customer A', 'a@gmail.com', 'hash6', '090000006', 'CUSTOMER', NULL),
('Customer B', 'b@gmail.com', 'hash7', '090000007', 'CUSTOMER', NULL),
('Customer C', 'c@gmail.com', 'hash8', '090000008', 'CUSTOMER', NULL),
('Customer D', 'd@gmail.com', 'hash9', '090000009', 'CUSTOMER', NULL),
('Customer E', 'e@gmail.com', 'hash10', '090000010', 'CUSTOMER', NULL);

INSERT INTO movies (title, duration, age_rating, description, status) VALUES
('Avengers', 150, 'C13', 'Superhero movie', 'now_showing'),
('Batman', 140, 'C16', 'DC superhero', 'now_showing'),
('Inception', 148, 'C13', 'Mind bending', 'now_showing'),
('Interstellar', 169, 'C13', 'Space movie', 'now_showing'),
('Conjuring', 112, 'C18', 'Horror movie', 'now_showing'),
('Avatar', 162, 'C13', 'Sci-fi epic', 'upcoming'),
('Titanic', 195, 'C13', 'Romance drama', 'stopped'),
('Joker', 122, 'C18', 'Psychological', 'now_showing'),
('Fast X', 140, 'C16', 'Action racing', 'now_showing'),
('Kungfu Panda', 95, 'P', 'Animation', 'upcoming');

INSERT INTO genres (genre_name) VALUES
('Action'),('Comedy'),('Horror'),('Sci-Fi'),('Romance'),
('Drama'),('Animation'),('Thriller'),('Adventure'),('Fantasy');

INSERT INTO movie_genres (movie_id, genre_id) VALUES
(1,1),(1,4),(1,9),
(2,1),(2,6),
(3,4),(3,8),
(4,4),(4,6),
(5,3);

INSERT INTO branch_movies (branch_id, movie_id) VALUES
(1,1),(1,2),(1,3),
(2,1),(2,3),(2,4),
(3,1),(3,5),
(4,2),(4,3),
(5,1),(5,4);

INSERT INTO rooms (branch_id, room_name, total_seats) VALUES
(1,'Room 1',100),
(1,'Room 2',120),
(2,'Room 1',90),
(2,'Room 2',110),
(3,'Room 1',80),
(4,'Room 1',100),
(5,'Room 1',150);

INSERT INTO seats (room_id, seat_row, seat_number, seat_type) VALUES
(1,'A',1,'NORMAL'),(1,'A',2,'NORMAL'),
(1,'B',1,'VIP'),(1,'B',2,'VIP'),
(2,'A',1,'NORMAL'),(2,'A',2,'NORMAL'),
(3,'A',1,'NORMAL'),(3,'A',2,'VIP'),
(4,'A',1,'NORMAL'),(5,'A',1,'COUPLE');

INSERT INTO showtimes (movie_id, room_id, start_time, end_time) VALUES
(1,1,'2026-02-06 10:00','2026-02-06 12:30'),
(2,2,'2026-02-06 13:00','2026-02-06 15:20'),
(3,3,'2026-02-06 16:00','2026-02-06 18:30'),
(4,4,'2026-02-06 19:00','2026-02-06 21:50'),
(5,5,'2026-02-06 22:00','2026-02-07 00:00');

INSERT INTO pricing (branch_id, seat_type, time_range, price) VALUES
(1,'NORMAL','morning',70000),
(1,'VIP','evening',120000),
(2,'NORMAL','morning',65000),
(2,'VIP','evening',110000),
(3,'NORMAL','all_day',60000);

INSERT INTO bookings (user_id, showtime_id, status, total_amount) VALUES
(6,1,'paid',140000),
(7,2,'paid',120000),
(8,3,'pending',70000),
(9,4,'paid',80000),
(10,5,'cancelled',0);

INSERT INTO booking_seats (booking_id, seat_id) VALUES
(1,1),(1,2),
(2,3),
(3,4),
(4,5);

INSERT INTO payments (booking_id, method, amount, payment_status) VALUES
(1,'online',140000,'success'),
(2,'card',120000,'success'),
(3,'online',70000,'failed'),
(4,'cash',80000,'success');

INSERT INTO reviews (movie_id, user_id, rating, comment) VALUES
(1,6,5,'Very good'),
(2,7,4,'Nice movie'),
(3,8,5,'Excellent'),
(4,9,4,'Great'),
(5,10,3,'Scary');

INSERT INTO notifications (user_id, title, content) VALUES
(6,'Booking Confirmed','Your booking is confirmed'),
(7,'Payment Success','Payment completed'),
(8,'Payment Failed','Please retry payment'),
(9,'Showtime Reminder','Movie starts soon'),
(10,'New Movie','New movie released');